# name: React Component Extraction (Schema Generation)

# on:
#   pull_request:
#     paths:
#       - "src/**/*.jsx"
#       - "src/**/*.tsx"

# permissions:
#   contents: read
#   pull-requests: write

# jobs:
#   extract-react-schema:
#     runs-on: ubuntu-latest

#     steps:
#       # STEP 0: Checkout
#       - name: Checkout React repository
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0

#       # STEP 1: Setup Node
#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: "18"

#       - name: Install dependencies
#         run: npm install --legacy-peer-deps

#       # STEP 2: Detect changed files
#       - name: Detect changed JSX / TSX files
#         id: changed-files
#         run: |
#           echo "üîç Detecting changed React components..."
#           FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E '\.jsx$|\.tsx$' || true)
#           echo "Changed files:"
#           echo "$FILES"
#           FILES_SINGLE_LINE=$(echo "$FILES" | tr '\n' ' ')
#           echo "files=$FILES_SINGLE_LINE" >> $GITHUB_OUTPUT

#       # STEP 3: Run extractor
#       - name: Run component analysis & extraction
#         if: steps.changed-files.outputs.files != ''
#         run: |
#           echo "üöÄ Running React component extractor..."
#           echo "Files under analysis:"
#           echo "${{ steps.changed-files.outputs.files }}"
#           mkdir -p context
#           node scripts/extractor/index.js

#       # STEP 4: Display generated schema neatly
#       - name: Display generated schema
#         if: steps.changed-files.outputs.files != ''
#         run: |
#           SCHEMA_FILE="context/react-component-schema.json"
#           if [ -f "$SCHEMA_FILE" ]; then
#             echo "üì¶ Generated React Component Schema:"
#             echo "-----------------------------------"
#             cat "$SCHEMA_FILE"
#             echo "-----------------------------------"
#             echo "‚úÖ Schema displayed successfully"
#           else
#             echo "‚ö†Ô∏è Schema file not found: $SCHEMA_FILE"
#             exit 1
#           fi

#       # STEP 5: Upload artifact
#       - name: Upload schema artifact
#         if: steps.changed-files.outputs.files != ''
#         uses: actions/upload-artifact@v4
#         with:
#           name: react-component-schema
#           path: context/react-component-schema.json

#       # STEP 6: Comment PR with extraction summary
#       - name: Comment PR with extraction summary
#         if: steps.changed-files.outputs.files != ''
#         uses: actions/github-script@v6
#         with:
#           script: |
#             const fs = require("fs");
#             const schemaPath = "context/react-component-schema.json";

#             if (!fs.existsSync(schemaPath)) {
#               console.log("Schema not found. Skipping PR comment.");
#               return;
#             }

#             const schema = JSON.parse(fs.readFileSync(schemaPath, "utf8"));

#             let body = "## üß© React Component Extraction Completed\n\n";
#             body += "**Component Name:** " + (schema.componentName || "N/A") + "\n\n";
#             body += "### üì¶ Extracted Signals\n";
#             body += "- **Props:** " + ((schema.props || []).map(p => p.name).join(", ") || "None") + "\n";
#             body += "- **Hooks:** " + ((schema.hooks || []).join(", ") || "None") + "\n";
#             body += "- **Child Components:** " + ((schema.children || []).join(", ") || "None") + "\n";
#             body += "- **Related Files:** " + ((schema.relatedFiles || []).join(", ") || "None") + "\n\n";
#             body += "‚úÖ Schema successfully generated and stored.";

#             github.rest.issues.createComment({
#               issue_number: context.issue.number,
#               owner: context.repo.owner,
#               repo: context.repo.repo,
#               body: body
#             });

name: React Component Extraction + UTG Context Generation

on:
  pull_request:
    paths:
      - "src/**/*.jsx"
      - "src/**/*.tsx"

permissions:
  contents: read
  pull-requests: write

jobs:
  extract-react-context:
    runs-on: ubuntu-latest

    steps:
      # =====================================================
      # STEP 0 ‚Äî Checkout Repository
      # =====================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # =====================================================
      # STEP 1 ‚Äî Setup Node
      # =====================================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      # =====================================================
      # STEP 2 ‚Äî Detect changed React files
      # =====================================================
      - name: Detect changed React components
        id: changed-files
        run: |
          echo "üîç Detecting changed JSX / TSX files..."

          FILES=$(git diff --name-only \
            ${{ github.event.pull_request.base.sha }} \
            ${{ github.sha }} | grep -E '\.jsx$|\.tsx$' || true)

          echo "Changed files:"
          echo "$FILES"

          FILES_SINGLE_LINE=$(echo "$FILES" | tr '\n' ' ')
          echo "files=$FILES_SINGLE_LINE" >> $GITHUB_OUTPUT

      # =====================================================
      # STEP 3 ‚Äî Run Extractor (Schema + UTG Prompt)
      # =====================================================
      - name: Run React context extraction pipeline
        if: steps.changed-files.outputs.files != ''
        run: |
          echo "üöÄ Running React context extraction..."
          echo "Files under analysis:"
          echo "${{ steps.changed-files.outputs.files }}"

          mkdir -p context
          node scripts/extractor/index.js

      # =====================================================
      # STEP 4 ‚Äî Display Schema
      # =====================================================
      - name: Display generated component schema
        if: steps.changed-files.outputs.files != ''
        run: |
          SCHEMA_FILE="context/react-component-schema.json"

          if [ -f "$SCHEMA_FILE" ]; then
            echo "üì¶ React Component Schema"
            echo "-----------------------------------"
            cat "$SCHEMA_FILE"
            echo "-----------------------------------"
          else
            echo "‚ùå Schema file not found"
            exit 1
          fi

      # =====================================================
      # STEP 5 ‚Äî Display UTG Prompt (LLM Context)
      # =====================================================
      - name: Display UTG prompt (LLM context)
        if: steps.changed-files.outputs.files != ''
        run: |
          UTG_FILE="context/utg-prompt.json"

          if [ -f "$UTG_FILE" ]; then
            echo "ü§ñ UTG Prompt (Schema + FULL Source Code)"
            echo "-----------------------------------"
            cat "$UTG_FILE"
            echo "-----------------------------------"
          else
            echo "‚ùå UTG prompt file not found"
            exit 1
          fi

      # =====================================================
      # STEP 6 ‚Äî Upload Artifacts
      # =====================================================
      - name: Upload extraction artifacts
        if: steps.changed-files.outputs.files != ''
        uses: actions/upload-artifact@v4
        with:
          name: react-context-artifacts
          path: |
            context/react-component-schema.json
            context/utg-prompt.json

      # =====================================================
      # STEP 7 ‚Äî Comment PR Summary
      # =====================================================
      - name: Comment PR with extraction summary
        if: steps.changed-files.outputs.files != ''
        run: node scripts/comment-pr.js
