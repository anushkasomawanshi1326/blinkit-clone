# # # name: Auto Test Generation

# # # on:
# # #   pull_request:
# # #     paths:
# # #       - 'src/**/*.jsx'
# # #       - 'src/**/*.tsx'

# # # jobs:
# # #   generate-tests:
# # #     runs-on: ubuntu-latest

# # #     steps:
# # #       # 1Ô∏è‚É£ Checkout React project
# # #       - name: Checkout React project
# # #         uses: actions/checkout@v3
# # #         with:
# # #           fetch-depth: 0

# # #       # 2Ô∏è‚É£ Setup Node (for React tests)
# # #       - name: Set up Node.js
# # #         uses: actions/setup-node@v3
# # #         with:
# # #           node-version: '18'

# # #       - name: Install npm dependencies
# # #         run: npm install --legacy-peer-deps

# # #       # 3Ô∏è‚É£ Get changed JSX/TSX files
# # #       - name: Get changed files
# # #         id: changed-files
# # #         run: |
# # #           FILES=$(git diff --name-only \
# # #             ${{ github.event.pull_request.base.sha }} \
# # #             ${{ github.sha }} | grep -E '\.jsx$|\.tsx$' | xargs)
# # #           echo "files=$FILES" >> $GITHUB_OUTPUT

# # #       # 4Ô∏è‚É£ Checkout PRIVATE UTG repo using PAT
# # #       - name: Checkout UnitTestGenerationSystem (PRIVATE)
# # #         if: steps.changed-files.outputs.files != ''
# # #         uses: actions/checkout@v3
# # #         with:
# # #           repository: prakalps/UnitTestGenerationSystem
# # #           token: ${{ secrets.GH_TOKEN }}
# # #           path: utg

# # #       # 5Ô∏è‚É£ Setup Python for UTG
# # #       - name: Set up Python
# # #         if: steps.changed-files.outputs.files != ''
# # #         uses: actions/setup-python@v4
# # #         with:
# # #           python-version: '3.10'

# # #       - name: Install UTG dependencies
# # #         if: steps.changed-files.outputs.files != ''
# # #         run: |
# # #           pip install openai python-dotenv

# # #       # 6Ô∏è‚É£ Run UTG test generation
# # #       - name: Generate tests using UTG
# # #         if: steps.changed-files.outputs.files != ''
# # #         env:
# # #           OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
# # #         run: |
# # #           python utg/scripts/agentic_pr_generator.py \
# # #             ${{ steps.changed-files.outputs.files }}

# # #       # 7Ô∏è‚É£ Run React tests
# # #       - name: Run generated tests
# # #         run: npm test -- --coverage

# # #       # 8Ô∏è‚É£ Commit generated tests back to PR branch
# # #       - name: Commit generated tests
# # #         run: |
# # #           git config --global user.name 'github-actions[bot]'
# # #           git config --global user.email 'github-actions[bot]@users.noreply.github.com'
# # #           git add .
# # #           git commit -m "chore: add agentic generated tests [skip ci]" || echo "No changes"
# # #           git push

# # #       # 9Ô∏è‚É£ Comment PR with results
# # #       - name: Comment PR with results
# # #         uses: actions/github-script@v6
# # #         if: always()
# # #         with:
# # #           script: |
# # #             const fs = require('fs');
# # #             const path = 'src/logs/pr_test_generation.json';
# # #             if (!fs.existsSync(path)) return;

# # #             const results = JSON.parse(fs.readFileSync(path, 'utf8'));

# # #             const comment = `## ü§ñ Agentic Test Generation Results

# # #             **Files Processed:** ${results.filesProcessed}
# # #             **Tests Generated:** ${results.testsGenerated}
# # #             **Tests Passed:** ${results.testsPassed} ‚úÖ

# # #             ### üí∞ Cost Report
# # #             - **Total Cost:** $${results.cost_report.total_cost}
# # #             - **Total Tokens:** ${results.cost_report.total_tokens}
# # #             `;

# # #             github.rest.issues.createComment({
# # #               issue_number: context.issue.number,
# # #               owner: context.repo.owner,
# # #               repo: context.repo.repo,
# # #               body: comment
# # #             });

# # # name: Auto Test Generation

# # # on:
# # #   pull_request:
# # #     paths:
# # #       - 'src/**/*.jsx'
# # #       - 'src/**/*.tsx'

# # # jobs:
# # #   generate-tests:
# # #     runs-on: ubuntu-latest

# # #     steps:
# # #       # 1Ô∏è‚É£ Checkout React project
# # #       - name: Checkout React project
# # #         uses: actions/checkout@v3
# # #         with:
# # #           fetch-depth: 0

# # #       # 2Ô∏è‚É£ Setup Node (for React tests)
# # #       - name: Set up Node.js
# # #         uses: actions/setup-node@v3
# # #         with:
# # #           node-version: '18'

# # #       - name: Install npm dependencies
# # #         run: npm install --legacy-peer-deps

# # #       # 3Ô∏è‚É£ Get changed JSX/TSX files
# # #       - name: Get changed files
# # #         id: changed-files
# # #         run: |
# # #           FILES=$(git diff --name-only \
# # #             ${{ github.event.pull_request.base.sha }} \
# # #             ${{ github.sha }} | grep -E '\.jsx$|\.tsx$' | xargs)
# # #           echo "files=$FILES" >> $GITHUB_OUTPUT

# # #       # 4Ô∏è‚É£ Checkout PRIVATE UTG repo using PAT
# # #       - name: Checkout UnitTestGenerationSystem (PRIVATE)
# # #         if: steps.changed-files.outputs.files != ''
# # #         uses: actions/checkout@v3
# # #         with:
# # #           repository: prakalps/UnitTestGenerationSystem
# # #           token: ${{ secrets.GH_TOKEN }}
# # #           path: utg

# # #       # 5Ô∏è‚É£ Setup Python for UTG
# # #       - name: Set up Python
# # #         if: steps.changed-files.outputs.files != ''
# # #         uses: actions/setup-python@v4
# # #         with:
# # #           python-version: '3.10'

# # #       - name: Install UTG dependencies
# # #         if: steps.changed-files.outputs.files != ''
# # #         run: |
# # #           pip install openai python-dotenv

# # #       # 6Ô∏è‚É£ Run UTG test generation
# # #       - name: Generate tests using UTG
# # #         if: steps.changed-files.outputs.files != ''
# # #         env:
# # #           OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
# # #         run: |
# # #           python utg/scripts/agentic_pr_generator.py \
# # #             ${{ steps.changed-files.outputs.files }}

# # #       # 7Ô∏è‚É£ Run React tests
# # #       - name: Run generated tests
# # #         run: npm test -- --coverage

# # #       # 8Ô∏è‚É£ Commit generated tests back to PR branch (FIXED)
# # #       - name: Commit generated tests
# # #         run: |
# # #           git config --global user.name 'github-actions[bot]'
# # #           git config --global user.email 'github-actions[bot]@users.noreply.github.com'
# # #           git add .
# # #           git commit -m "chore: add agentic generated tests [skip ci]" || echo "No changes"
# # #           git push origin HEAD:${{ github.head_ref }}

# # #       # 9Ô∏è‚É£ Comment PR with results
# # #       - name: Comment PR with results
# # #         uses: actions/github-script@v6
# # #         if: always()
# # #         with:
# # #           script: |
# # #             const fs = require('fs');
# # #             const path = 'src/logs/pr_test_generation.json';
# # #             if (!fs.existsSync(path)) return;

# # #             const results = JSON.parse(fs.readFileSync(path, 'utf8'));

# # #             const comment = `## ü§ñ Agentic Test Generation Results

# # #             **Files Processed:** ${results.filesProcessed}
# # #             **Tests Generated:** ${results.testsGenerated}
# # #             **Tests Passed:** ${results.testsPassed} ‚úÖ

# # #             ### üí∞ Cost Report
# # #             - **Total Cost:** $${results.cost_report.total_cost}
# # #             - **Total Tokens:** ${results.cost_report.total_tokens}
# # #             `;

# # #             github.rest.issues.createComment({
# # #               issue_number: context.issue.number,
# # #               owner: context.repo.owner,
# # #               repo: context.repo.repo,
# # #               body: comment
# # #             });

# # # name: Auto Test Generation

# # # on:
# # #   pull_request:
# # #     paths:
# # #       - 'src/**/*.jsx'
# # #       - 'src/**/*.tsx'

# # # jobs:
# # #   generate-tests:
# # #     runs-on: ubuntu-latest

# # #     steps:
# # #       # 1Ô∏è‚É£ Checkout React project
# # #       - name: Checkout React project
# # #         uses: actions/checkout@v3
# # #         with:
# # #           fetch-depth: 0

# # #       # 2Ô∏è‚É£ Setup Node (for React tests)
# # #       - name: Set up Node.js
# # #         uses: actions/setup-node@v3
# # #         with:
# # #           node-version: '18'

# # #       - name: Install npm dependencies
# # #         run: npm install --legacy-peer-deps

# # #       # 3Ô∏è‚É£ Get changed JSX/TSX files
# # #       - name: Get changed files
# # #         id: changed-files
# # #         run: |
# # #           FILES=$(git diff --name-only \
# # #             ${{ github.event.pull_request.base.sha }} \
# # #             ${{ github.sha }} | grep -E '\.jsx$|\.tsx$' | xargs)
# # #           echo "files=$FILES" >> $GITHUB_OUTPUT

# # #       # 4Ô∏è‚É£ Checkout PRIVATE UTG repo using PAT
# # #       - name: Checkout UnitTestGenerationSystem (PRIVATE)
# # #         if: steps.changed-files.outputs.files != ''
# # #         uses: actions/checkout@v3
# # #         with:
# # #           repository: prakalps/UnitTestGenerationSystem
# # #           token: ${{ secrets.GH_TOKEN }}
# # #           path: utg

# # #       # 5Ô∏è‚É£ Setup Python for UTG
# # #       - name: Set up Python
# # #         if: steps.changed-files.outputs.files != ''
# # #         uses: actions/setup-python@v4
# # #         with:
# # #           python-version: '3.10'

# # #       - name: Install UTG dependencies
# # #         if: steps.changed-files.outputs.files != ''
# # #         run: |
# # #           pip install openai python-dotenv

# # #       # 6Ô∏è‚É£ Run UTG test generation
# # #       - name: Generate tests using UTG
# # #         if: steps.changed-files.outputs.files != ''
# # #         env:
# # #           OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
# # #         run: |
# # #           python utg/scripts/agentic_pr_generator.py \
# # #             ${{ steps.changed-files.outputs.files }}

# # #       # 7Ô∏è‚É£ Run React tests
# # #       - name: Run generated tests
# # #         run: npm test -- --coverage

# # #       # 8Ô∏è‚É£ Commit generated tests back to PR branch
# # #       - name: Commit generated tests
# # #         run: |
# # #           git config --global user.name 'github-actions[bot]'
# # #           git config --global user.email 'github-actions[bot]@users.noreply.github.com'
# # #           git add .
# # #           git commit -m "chore: add agentic generated tests [skip ci]" || echo "No changes"
# # #           git push origin HEAD:${{ github.head_ref }}

# # #       # 9Ô∏è‚É£ Comment PR with results (SAFE GUARDED)
# # #       - name: Comment PR with results
# # #         uses: actions/github-script@v6
# # #         if: always()
# # #         with:
# # #           script: |
# # #             const fs = require('fs');
# # #             const path = 'src/logs/pr_test_generation.json';

# # #             if (!fs.existsSync(path)) {
# # #               console.log("UTG results file not found, skipping comment.");
# # #               return;
# # #             }

# # #             const results = JSON.parse(fs.readFileSync(path, 'utf8'));

# # #             const costReport = results.cost_report || {};
# # #             const totalCost = costReport.total_cost ?? "N/A";
# # #             const totalTokens = costReport.total_tokens ?? "N/A";

# # #             const comment = `## ü§ñ Agentic Test Generation Results

# # #             **Files Processed:** ${results.filesProcessed ?? "N/A"}
# # #             **Tests Generated:** ${results.testsGenerated ?? "N/A"}
# # #             **Tests Passed:** ${results.testsPassed ?? "N/A"} ‚úÖ

# # #             ### üí∞ Cost Report
# # #             - **Total Cost:** ${totalCost}
# # #             - **Total Tokens:** ${totalTokens}
# # #             `;

# # #             github.rest.issues.createComment({
# # #               issue_number: context.issue.number,
# # #               owner: context.repo.owner,
# # #               repo: context.repo.repo,
# # #               body: comment
# # #             });


name: Auto Test Generation

on:
  pull_request:
    paths:
      - 'src/**/*.jsx'
      - 'src/**/*.tsx'

# ‚úÖ REQUIRED PERMISSIONS (FIXES 403 ERROR)
permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  generate-tests:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout React project
      - name: Checkout React project
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Setup Node (for React tests)
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install npm dependencies
        run: npm install --legacy-peer-deps

      # 3Ô∏è‚É£ Get changed JSX/TSX files
      - name: Get changed files
        id: changed-files
        run: |
          FILES=$(git diff --name-only \
            ${{ github.event.pull_request.base.sha }} \
            ${{ github.sha }} | grep -E '\.jsx$|\.tsx$' | xargs)
          echo "files=$FILES" >> $GITHUB_OUTPUT

      # 4Ô∏è‚É£ Checkout PRIVATE UTG repo using PAT
      - name: Checkout UnitTestGenerationSystem (PRIVATE)
        if: steps.changed-files.outputs.files != ''
        uses: actions/checkout@v3
        with:
          repository: prakalps/UnitTestGenerationSystem
          token: ${{ secrets.GH_TOKEN }}
          path: utg

      # 5Ô∏è‚É£ Setup Python for UTG
      - name: Set up Python
        if: steps.changed-files.outputs.files != ''
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install UTG dependencies
        if: steps.changed-files.outputs.files != ''
        run: |
          pip install openai python-dotenv

      # 6Ô∏è‚É£ Run UTG test generation
      - name: Generate tests using UTG
        if: steps.changed-files.outputs.files != ''
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python utg/scripts/agentic_pr_generator.py \
            ${{ steps.changed-files.outputs.files }}

      # 7Ô∏è‚É£ Run React tests
      - name: Run generated tests
        run: npm test -- --coverage

      # 8Ô∏è‚É£ Commit generated tests back to PR branch
      - name: Commit generated tests
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          git commit -m "chore: add agentic generated tests [skip ci]" || echo "No changes"
          git push origin HEAD:${{ github.head_ref }}

      # 9Ô∏è‚É£ Comment PR with results (SAFE GUARDED)
      - name: Comment PR with results
        uses: actions/github-script@v6
        if: always()
        with:
          script: |
            const fs = require('fs');
            const path = 'src/logs/pr_test_generation.json';

            if (!fs.existsSync(path)) {
              console.log("UTG results file not found, skipping comment.");
              return;
            }

            const results = JSON.parse(fs.readFileSync(path, 'utf8'));

            const costReport = results.cost_report || {};
            const totalCost = costReport.total_cost ?? "N/A";
            const totalTokens = costReport.total_tokens ?? "N/A";

            const comment = `## ü§ñ Agentic Test Generation Results

            **Files Processed:** ${results.filesProcessed ?? "N/A"}
            **Tests Generated:** ${results.testsGenerated ?? "N/A"}
            **Tests Passed:** ${results.testsPassed ?? "N/A"} ‚úÖ

            ### üí∞ Cost Report
            - **Total Cost:** ${totalCost}
            - **Total Tokens:** ${totalTokens}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

