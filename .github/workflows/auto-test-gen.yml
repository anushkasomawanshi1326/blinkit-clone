# # # name: Auto Test Generation

# # # on:
# # #   pull_request:
# # #     paths:
# # #       - 'src/**/*.jsx'
# # #       - 'src/**/*.tsx'

# # # jobs:
# # #   generate-tests:
# # #     runs-on: ubuntu-latest

# # #     steps:
# # #       # 1Ô∏è‚É£ Checkout React project
# # #       - name: Checkout React project
# # #         uses: actions/checkout@v3
# # #         with:
# # #           fetch-depth: 0

# # #       # 2Ô∏è‚É£ Setup Node (for React tests)
# # #       - name: Set up Node.js
# # #         uses: actions/setup-node@v3
# # #         with:
# # #           node-version: '18'

# # #       - name: Install npm dependencies
# # #         run: npm install --legacy-peer-deps

# # #       # 3Ô∏è‚É£ Get changed JSX/TSX files
# # #       - name: Get changed files
# # #         id: changed-files
# # #         run: |
# # #           FILES=$(git diff --name-only \
# # #             ${{ github.event.pull_request.base.sha }} \
# # #             ${{ github.sha }} | grep -E '\.jsx$|\.tsx$' | xargs)
# # #           echo "files=$FILES" >> $GITHUB_OUTPUT

# # #       # 4Ô∏è‚É£ Checkout PRIVATE UTG repo using PAT
# # #       - name: Checkout UnitTestGenerationSystem (PRIVATE)
# # #         if: steps.changed-files.outputs.files != ''
# # #         uses: actions/checkout@v3
# # #         with:
# # #           repository: prakalps/UnitTestGenerationSystem
# # #           token: ${{ secrets.GH_TOKEN }}
# # #           path: utg

# # #       # 5Ô∏è‚É£ Setup Python for UTG
# # #       - name: Set up Python
# # #         if: steps.changed-files.outputs.files != ''
# # #         uses: actions/setup-python@v4
# # #         with:
# # #           python-version: '3.10'

# # #       - name: Install UTG dependencies
# # #         if: steps.changed-files.outputs.files != ''
# # #         run: |
# # #           pip install openai python-dotenv

# # #       # 6Ô∏è‚É£ Run UTG test generation
# # #       - name: Generate tests using UTG
# # #         if: steps.changed-files.outputs.files != ''
# # #         env:
# # #           OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
# # #         run: |
# # #           python utg/scripts/agentic_pr_generator.py \
# # #             ${{ steps.changed-files.outputs.files }}

# # #       # 7Ô∏è‚É£ Run React tests
# # #       - name: Run generated tests
# # #         run: npm test -- --coverage

# # #       # 8Ô∏è‚É£ Commit generated tests back to PR branch
# # #       - name: Commit generated tests
# # #         run: |
# # #           git config --global user.name 'github-actions[bot]'
# # #           git config --global user.email 'github-actions[bot]@users.noreply.github.com'
# # #           git add .
# # #           git commit -m "chore: add agentic generated tests [skip ci]" || echo "No changes"
# # #           git push

# # #       # 9Ô∏è‚É£ Comment PR with results
# # #       - name: Comment PR with results
# # #         uses: actions/github-script@v6
# # #         if: always()
# # #         with:
# # #           script: |
# # #             const fs = require('fs');
# # #             const path = 'src/logs/pr_test_generation.json';
# # #             if (!fs.existsSync(path)) return;

# # #             const results = JSON.parse(fs.readFileSync(path, 'utf8'));

# # #             const comment = `## ü§ñ Agentic Test Generation Results

# # #             **Files Processed:** ${results.filesProcessed}
# # #             **Tests Generated:** ${results.testsGenerated}
# # #             **Tests Passed:** ${results.testsPassed} ‚úÖ

# # #             ### üí∞ Cost Report
# # #             - **Total Cost:** $${results.cost_report.total_cost}
# # #             - **Total Tokens:** ${results.cost_report.total_tokens}
# # #             `;

# # #             github.rest.issues.createComment({
# # #               issue_number: context.issue.number,
# # #               owner: context.repo.owner,
# # #               repo: context.repo.repo,
# # #               body: comment
# # #             });

# # # name: Auto Test Generation

# # # on:
# # #   pull_request:
# # #     paths:
# # #       - 'src/**/*.jsx'
# # #       - 'src/**/*.tsx'

# # # jobs:
# # #   generate-tests:
# # #     runs-on: ubuntu-latest

# # #     steps:
# # #       # 1Ô∏è‚É£ Checkout React project
# # #       - name: Checkout React project
# # #         uses: actions/checkout@v3
# # #         with:
# # #           fetch-depth: 0

# # #       # 2Ô∏è‚É£ Setup Node (for React tests)
# # #       - name: Set up Node.js
# # #         uses: actions/setup-node@v3
# # #         with:
# # #           node-version: '18'

# # #       - name: Install npm dependencies
# # #         run: npm install --legacy-peer-deps

# # #       # 3Ô∏è‚É£ Get changed JSX/TSX files
# # #       - name: Get changed files
# # #         id: changed-files
# # #         run: |
# # #           FILES=$(git diff --name-only \
# # #             ${{ github.event.pull_request.base.sha }} \
# # #             ${{ github.sha }} | grep -E '\.jsx$|\.tsx$' | xargs)
# # #           echo "files=$FILES" >> $GITHUB_OUTPUT

# # #       # 4Ô∏è‚É£ Checkout PRIVATE UTG repo using PAT
# # #       - name: Checkout UnitTestGenerationSystem (PRIVATE)
# # #         if: steps.changed-files.outputs.files != ''
# # #         uses: actions/checkout@v3
# # #         with:
# # #           repository: prakalps/UnitTestGenerationSystem
# # #           token: ${{ secrets.GH_TOKEN }}
# # #           path: utg

# # #       # 5Ô∏è‚É£ Setup Python for UTG
# # #       - name: Set up Python
# # #         if: steps.changed-files.outputs.files != ''
# # #         uses: actions/setup-python@v4
# # #         with:
# # #           python-version: '3.10'

# # #       - name: Install UTG dependencies
# # #         if: steps.changed-files.outputs.files != ''
# # #         run: |
# # #           pip install openai python-dotenv

# # #       # 6Ô∏è‚É£ Run UTG test generation
# # #       - name: Generate tests using UTG
# # #         if: steps.changed-files.outputs.files != ''
# # #         env:
# # #           OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
# # #         run: |
# # #           python utg/scripts/agentic_pr_generator.py \
# # #             ${{ steps.changed-files.outputs.files }}

# # #       # 7Ô∏è‚É£ Run React tests
# # #       - name: Run generated tests
# # #         run: npm test -- --coverage

# # #       # 8Ô∏è‚É£ Commit generated tests back to PR branch (FIXED)
# # #       - name: Commit generated tests
# # #         run: |
# # #           git config --global user.name 'github-actions[bot]'
# # #           git config --global user.email 'github-actions[bot]@users.noreply.github.com'
# # #           git add .
# # #           git commit -m "chore: add agentic generated tests [skip ci]" || echo "No changes"
# # #           git push origin HEAD:${{ github.head_ref }}

# # #       # 9Ô∏è‚É£ Comment PR with results
# # #       - name: Comment PR with results
# # #         uses: actions/github-script@v6
# # #         if: always()
# # #         with:
# # #           script: |
# # #             const fs = require('fs');
# # #             const path = 'src/logs/pr_test_generation.json';
# # #             if (!fs.existsSync(path)) return;

# # #             const results = JSON.parse(fs.readFileSync(path, 'utf8'));

# # #             const comment = `## ü§ñ Agentic Test Generation Results

# # #             **Files Processed:** ${results.filesProcessed}
# # #             **Tests Generated:** ${results.testsGenerated}
# # #             **Tests Passed:** ${results.testsPassed} ‚úÖ

# # #             ### üí∞ Cost Report
# # #             - **Total Cost:** $${results.cost_report.total_cost}
# # #             - **Total Tokens:** ${results.cost_report.total_tokens}
# # #             `;

# # #             github.rest.issues.createComment({
# # #               issue_number: context.issue.number,
# # #               owner: context.repo.owner,
# # #               repo: context.repo.repo,
# # #               body: comment
# # #             });

# # # name: Auto Test Generation

# # # on:
# # #   pull_request:
# # #     paths:
# # #       - 'src/**/*.jsx'
# # #       - 'src/**/*.tsx'

# # # jobs:
# # #   generate-tests:
# # #     runs-on: ubuntu-latest

# # #     steps:
# # #       # 1Ô∏è‚É£ Checkout React project
# # #       - name: Checkout React project
# # #         uses: actions/checkout@v3
# # #         with:
# # #           fetch-depth: 0

# # #       # 2Ô∏è‚É£ Setup Node (for React tests)
# # #       - name: Set up Node.js
# # #         uses: actions/setup-node@v3
# # #         with:
# # #           node-version: '18'

# # #       - name: Install npm dependencies
# # #         run: npm install --legacy-peer-deps

# # #       # 3Ô∏è‚É£ Get changed JSX/TSX files
# # #       - name: Get changed files
# # #         id: changed-files
# # #         run: |
# # #           FILES=$(git diff --name-only \
# # #             ${{ github.event.pull_request.base.sha }} \
# # #             ${{ github.sha }} | grep -E '\.jsx$|\.tsx$' | xargs)
# # #           echo "files=$FILES" >> $GITHUB_OUTPUT

# # #       # 4Ô∏è‚É£ Checkout PRIVATE UTG repo using PAT
# # #       - name: Checkout UnitTestGenerationSystem (PRIVATE)
# # #         if: steps.changed-files.outputs.files != ''
# # #         uses: actions/checkout@v3
# # #         with:
# # #           repository: prakalps/UnitTestGenerationSystem
# # #           token: ${{ secrets.GH_TOKEN }}
# # #           path: utg

# # #       # 5Ô∏è‚É£ Setup Python for UTG
# # #       - name: Set up Python
# # #         if: steps.changed-files.outputs.files != ''
# # #         uses: actions/setup-python@v4
# # #         with:
# # #           python-version: '3.10'

# # #       - name: Install UTG dependencies
# # #         if: steps.changed-files.outputs.files != ''
# # #         run: |
# # #           pip install openai python-dotenv

# # #       # 6Ô∏è‚É£ Run UTG test generation
# # #       - name: Generate tests using UTG
# # #         if: steps.changed-files.outputs.files != ''
# # #         env:
# # #           OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
# # #         run: |
# # #           python utg/scripts/agentic_pr_generator.py \
# # #             ${{ steps.changed-files.outputs.files }}

# # #       # 7Ô∏è‚É£ Run React tests
# # #       - name: Run generated tests
# # #         run: npm test -- --coverage

# # #       # 8Ô∏è‚É£ Commit generated tests back to PR branch
# # #       - name: Commit generated tests
# # #         run: |
# # #           git config --global user.name 'github-actions[bot]'
# # #           git config --global user.email 'github-actions[bot]@users.noreply.github.com'
# # #           git add .
# # #           git commit -m "chore: add agentic generated tests [skip ci]" || echo "No changes"
# # #           git push origin HEAD:${{ github.head_ref }}

# # #       # 9Ô∏è‚É£ Comment PR with results (SAFE GUARDED)
# # #       - name: Comment PR with results
# # #         uses: actions/github-script@v6
# # #         if: always()
# # #         with:
# # #           script: |
# # #             const fs = require('fs');
# # #             const path = 'src/logs/pr_test_generation.json';

# # #             if (!fs.existsSync(path)) {
# # #               console.log("UTG results file not found, skipping comment.");
# # #               return;
# # #             }

# # #             const results = JSON.parse(fs.readFileSync(path, 'utf8'));

# # #             const costReport = results.cost_report || {};
# # #             const totalCost = costReport.total_cost ?? "N/A";
# # #             const totalTokens = costReport.total_tokens ?? "N/A";

# # #             const comment = `## ü§ñ Agentic Test Generation Results

# # #             **Files Processed:** ${results.filesProcessed ?? "N/A"}
# # #             **Tests Generated:** ${results.testsGenerated ?? "N/A"}
# # #             **Tests Passed:** ${results.testsPassed ?? "N/A"} ‚úÖ

# # #             ### üí∞ Cost Report
# # #             - **Total Cost:** ${totalCost}
# # #             - **Total Tokens:** ${totalTokens}
# # #             `;

# # #             github.rest.issues.createComment({
# # #               issue_number: context.issue.number,
# # #               owner: context.repo.owner,
# # #               repo: context.repo.repo,
# # #               body: comment
# # #             });


# name: Auto Test Generation

# on:
#   pull_request:
#     paths:
#       - 'src/**/*.jsx'
#       - 'src/**/*.tsx'

# # ‚úÖ REQUIRED PERMISSIONS (FIXES 403 ERROR)
# permissions:
#   contents: write
#   pull-requests: write
#   issues: write

# jobs:
#   generate-tests:
#     runs-on: ubuntu-latest

#     steps:
#       # 1Ô∏è‚É£ Checkout React project
#       - name: Checkout React project
#         uses: actions/checkout@v3
#         with:
#           fetch-depth: 0

#       # 2Ô∏è‚É£ Setup Node (for React tests)
#       - name: Set up Node.js
#         uses: actions/setup-node@v3
#         with:
#           node-version: '18'

#       - name: Install npm dependencies
#         run: npm install --legacy-peer-deps

#       # 3Ô∏è‚É£ Get changed JSX/TSX files
#       - name: Get changed files
#         id: changed-files
#         run: |
#           FILES=$(git diff --name-only \
#             ${{ github.event.pull_request.base.sha }} \
#             ${{ github.sha }} | grep -E '\.jsx$|\.tsx$' | xargs)
#           echo "files=$FILES" >> $GITHUB_OUTPUT

#       # 4Ô∏è‚É£ Checkout PRIVATE UTG repo using PAT
#       - name: Checkout UnitTestGenerationSystem (PRIVATE)
#         if: steps.changed-files.outputs.files != ''
#         uses: actions/checkout@v3
#         with:
#           repository: prakalps/UnitTestGenerationSystem
#           token: ${{ secrets.GH_TOKEN }}
#           path: utg

#       # 5Ô∏è‚É£ Setup Python for UTG
#       - name: Set up Python
#         if: steps.changed-files.outputs.files != ''
#         uses: actions/setup-python@v4
#         with:
#           python-version: '3.10'

#       - name: Install UTG dependencies
#         if: steps.changed-files.outputs.files != ''
#         run: |
#           pip install openai python-dotenv

#       # 6Ô∏è‚É£ Run UTG test generation
#       - name: Generate tests using UTG
#         if: steps.changed-files.outputs.files != ''
#         env:
#           OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
#         run: |
#           python utg/scripts/agentic_pr_generator.py \
#             ${{ steps.changed-files.outputs.files }}

#       # 7Ô∏è‚É£ Run React tests
#       - name: Run generated tests
#         run: npm test -- --coverage

#       # 8Ô∏è‚É£ Commit generated tests back to PR branch
#       - name: Commit generated tests
#         run: |
#           git config --global user.name 'github-actions[bot]'
#           git config --global user.email 'github-actions[bot]@users.noreply.github.com'
#           git add .
#           git commit -m "chore: add agentic generated tests [skip ci]" || echo "No changes"
#           git push origin HEAD:${{ github.head_ref }}

#       # 9Ô∏è‚É£ Comment PR with results (SAFE GUARDED)
#       - name: Comment PR with results
#         uses: actions/github-script@v6
#         if: always()
#         with:
#           script: |
#             const fs = require('fs');
#             const path = 'src/logs/pr_test_generation.json';

#             if (!fs.existsSync(path)) {
#               console.log("UTG results file not found, skipping comment.");
#               return;
#             }

#             const results = JSON.parse(fs.readFileSync(path, 'utf8'));

#             const costReport = results.cost_report || {};
#             const totalCost = costReport.total_cost ?? "N/A";
#             const totalTokens = costReport.total_tokens ?? "N/A";

#             const comment = `## ü§ñ Agentic Test Generation Results

#             **Files Processed:** ${results.filesProcessed ?? "N/A"}
#             **Tests Generated:** ${results.testsGenerated ?? "N/A"}
#             **Tests Passed:** ${results.testsPassed ?? "N/A"} ‚úÖ

#             ### üí∞ Cost Report
#             - **Total Cost:** ${totalCost}
#             - **Total Tokens:** ${totalTokens}
#             `;

#             github.rest.issues.createComment({
#               issue_number: context.issue.number,
#               owner: context.repo.owner,
#               repo: context.repo.repo,
#               body: comment
#             });

# auto-test-gen.yml file for the better llm context new one after the  PR1 solving 

name: Auto Test Generation (UTG)

on:
  pull_request:
    paths:
      - "src/**/*.jsx"
      - "src/**/*.tsx"

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # =====================================================
  # üß™ SANITY CHECK ‚Äî GUARANTEED CLEAN YAML
  # =====================================================
  sanity-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: echo "YAML is valid ‚úÖ"

  # =====================================================
  # ü§ñ AUTO TEST GENERATION PIPELINE
  # =====================================================
  auto-test-gen:
    runs-on: ubuntu-latest
    needs: sanity-check

    steps:
      # =====================================================
      # STEP 1 ‚Äî Checkout React Repository
      # =====================================================
      - name: Checkout React project
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # =====================================================
      # STEP 2 ‚Äî Setup Node.js
      # =====================================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install React dependencies
        run: npm install --legacy-peer-deps

      # =====================================================
      # STEP 3 ‚Äî Detect changed JSX / TSX files
      # =====================================================
      - name: Detect changed React files
        id: changed-files
        run: |
          FILES=$(git diff --name-only \
            ${{ github.event.pull_request.base.sha }} \
            ${{ github.sha }} | grep -E '\.jsx$|\.tsx$' || true)

          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "Changed files:"
          echo "$FILES"

      # =====================================================
      # STEP 4 ‚Äî React Context Extraction
      # =====================================================
      - name: Run React context extraction
        if: steps.changed-files.outputs.files != ''
        run: |
          mkdir -p context
          node scripts/extractor/index.js
          echo "Base UTG prompt created"

      # =====================================================
      # STEP 5 ‚Äî Append FULL SOURCE CODE (Dependency-aware)
      # =====================================================
      - name: Append dependency-aware source code
        if: steps.changed-files.outputs.files != ''
        run: |
          node <<'EOF'
          import fs from "fs";
          import path from "path";
          import { resolveDependencies } from "./scripts/extractor/dependencyResolver.js";

          const changedFiles = `${{ steps.changed-files.outputs.files }}`
            .split("\n")
            .map(f => f.trim())
            .filter(Boolean);

          const promptFile = "context/utg-prompt.txt";

          fs.appendFileSync(
            promptFile,
            `
====================================
üì¶ FULL SOURCE CODE CONTEXT
====================================
`
          );

          const added = new Set();

          for (const file of changedFiles) {
            const absPath = path.resolve(file);
            const deps = resolveDependencies(absPath);

            for (const dep of deps) {
              if (added.has(dep)) continue;
              added.add(dep);

              fs.appendFileSync(
                promptFile,
                `
------------------------------------
üìÑ FILE: ${dep}
------------------------------------
${fs.readFileSync(dep, "utf8")}
`
              );
            }
          }
          EOF

      # =====================================================
      # STEP 5.1 ‚Äî FAIL FAST VALIDATION
      # =====================================================
      - name: Ensure UTG includes changed files
        if: steps.changed-files.outputs.files != ''
        run: |
          for file in ${{ steps.changed-files.outputs.files }}; do
            base=$(basename "$file")
            grep -q "$base" context/utg-prompt.txt \
              || (echo "‚ùå Missing $base in UTG prompt" && exit 1)
          done

      # =====================================================
      # STEP 6 ‚Äî Validate UTG Prompt
      # =====================================================
      - name: Validate UTG prompt
        if: steps.changed-files.outputs.files != ''
        run: |
          test -f context/utg-prompt.txt
          wc -l context/utg-prompt.txt

      # =====================================================
      # STEP 7 ‚Äî Checkout PRIVATE UTG Repository
      # =====================================================
      - name: Checkout UTG system
        if: steps.changed-files.outputs.files != ''
        uses: actions/checkout@v4
        with:
          repository: prakalps/UnitTestGenerationSystem
          token: ${{ secrets.GH_TOKEN }}
          path: utg

      # =====================================================
      # STEP 8 ‚Äî Inject UTG Prompt
      # =====================================================
      - name: Inject UTG prompt
        if: steps.changed-files.outputs.files != ''
        run: |
          mkdir -p utg/context
          cp context/utg-prompt.txt utg/context/utg-prompt.txt

      # =====================================================
      # STEP 9 ‚Äî Setup Python
      # =====================================================
      - name: Setup Python
        if: steps.changed-files.outputs.files != ''
        uses: actions/setup-python@v5
        with:
          python-version: 3.10

      - name: Install UTG dependencies
        if: steps.changed-files.outputs.files != ''
        run: pip install -r utg/requirements.txt

      # =====================================================
      # STEP 10 ‚Äî Run UTG
      # =====================================================
      - name: Run UTG
        if: steps.changed-files.outputs.files != ''
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: python utg/scripts/pr_test_generator.py utg/context/utg-prompt.txt

      # =====================================================
      # STEP 11 ‚Äî Run React Tests
      # =====================================================
      - name: Run Jest tests
        run: npm test -- --coverage

      # =====================================================
      # STEP 12 ‚Äî Commit Generated Tests
      # =====================================================
      - name: Commit generated tests
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "chore: add UTG generated tests [skip ci]" || echo "No changes"
          git push origin HEAD:${{ github.head_ref }}

      # =====================================================
      # STEP 13 ‚Äî Comment PR with UTG Summary
      # =====================================================
      - name: Comment PR with UTG results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");

            const reportPath = "src/logs/pr_test_generation.json";
            if (!fs.existsSync(reportPath)) {
              console.log("No UTG report found");
              return;
            }

            const data = JSON.parse(fs.readFileSync(reportPath, "utf8"));

            const comment = `
## ü§ñ UTG Test Generation Report

**Files Processed:** ${data.filesProcessed ?? "N/A"}
**Tests Generated:** ${data.testsGenerated ?? "N/A"}
**Tests Passed:** ${data.testsPassed ?? "N/A"} ‚úÖ

**Total Tokens:** ${data.cost_report?.total_tokens ?? "N/A"}
**Total Cost:** ${data.cost_report?.total_cost ?? "N/A"}
`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
