# # # name: Auto Test Generation

# # # on:
# # #   pull_request:
# # #     paths:
# # #       - 'src/**/*.jsx'
# # #       - 'src/**/*.tsx'

# # # jobs:
# # #   generate-tests:
# # #     runs-on: ubuntu-latest

# # #     steps:
# # #       # 1Ô∏è‚É£ Checkout React project
# # #       - name: Checkout React project
# # #         uses: actions/checkout@v3
# # #         with:
# # #           fetch-depth: 0

# # #       # 2Ô∏è‚É£ Setup Node (for React tests)
# # #       - name: Set up Node.js
# # #         uses: actions/setup-node@v3
# # #         with:
# # #           node-version: '18'

# # #       - name: Install npm dependencies
# # #         run: npm install --legacy-peer-deps

# # #       # 3Ô∏è‚É£ Get changed JSX/TSX files
# # #       - name: Get changed files
# # #         id: changed-files
# # #         run: |
# # #           FILES=$(git diff --name-only \
# # #             ${{ github.event.pull_request.base.sha }} \
# # #             ${{ github.sha }} | grep -E '\.jsx$|\.tsx$' | xargs)
# # #           echo "files=$FILES" >> $GITHUB_OUTPUT

# # #       # 4Ô∏è‚É£ Checkout PRIVATE UTG repo using PAT
# # #       - name: Checkout UnitTestGenerationSystem (PRIVATE)
# # #         if: steps.changed-files.outputs.files != ''
# # #         uses: actions/checkout@v3
# # #         with:
# # #           repository: prakalps/UnitTestGenerationSystem
# # #           token: ${{ secrets.GH_TOKEN }}
# # #           path: utg

# # #       # 5Ô∏è‚É£ Setup Python for UTG
# # #       - name: Set up Python
# # #         if: steps.changed-files.outputs.files != ''
# # #         uses: actions/setup-python@v4
# # #         with:
# # #           python-version: '3.10'

# # #       - name: Install UTG dependencies
# # #         if: steps.changed-files.outputs.files != ''
# # #         run: |
# # #           pip install openai python-dotenv

# # #       # 6Ô∏è‚É£ Run UTG test generation
# # #       - name: Generate tests using UTG
# # #         if: steps.changed-files.outputs.files != ''
# # #         env:
# # #           OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
# # #         run: |
# # #           python utg/scripts/agentic_pr_generator.py \
# # #             ${{ steps.changed-files.outputs.files }}

# # #       # 7Ô∏è‚É£ Run React tests
# # #       - name: Run generated tests
# # #         run: npm test -- --coverage

# # #       # 8Ô∏è‚É£ Commit generated tests back to PR branch
# # #       - name: Commit generated tests
# # #         run: |
# # #           git config --global user.name 'github-actions[bot]'
# # #           git config --global user.email 'github-actions[bot]@users.noreply.github.com'
# # #           git add .
# # #           git commit -m "chore: add agentic generated tests [skip ci]" || echo "No changes"
# # #           git push

# # #       # 9Ô∏è‚É£ Comment PR with results
# # #       - name: Comment PR with results
# # #         uses: actions/github-script@v6
# # #         if: always()
# # #         with:
# # #           script: |
# # #             const fs = require('fs');
# # #             const path = 'src/logs/pr_test_generation.json';
# # #             if (!fs.existsSync(path)) return;

# # #             const results = JSON.parse(fs.readFileSync(path, 'utf8'));

# # #             const comment = `## ü§ñ Agentic Test Generation Results

# # #             **Files Processed:** ${results.filesProcessed}
# # #             **Tests Generated:** ${results.testsGenerated}
# # #             **Tests Passed:** ${results.testsPassed} ‚úÖ

# # #             ### üí∞ Cost Report
# # #             - **Total Cost:** $${results.cost_report.total_cost}
# # #             - **Total Tokens:** ${results.cost_report.total_tokens}
# # #             `;

# # #             github.rest.issues.createComment({
# # #               issue_number: context.issue.number,
# # #               owner: context.repo.owner,
# # #               repo: context.repo.repo,
# # #               body: comment
# # #             });

# # # name: Auto Test Generation

# # # on:
# # #   pull_request:
# # #     paths:
# # #       - 'src/**/*.jsx'
# # #       - 'src/**/*.tsx'

# # # jobs:
# # #   generate-tests:
# # #     runs-on: ubuntu-latest

# # #     steps:
# # #       # 1Ô∏è‚É£ Checkout React project
# # #       - name: Checkout React project
# # #         uses: actions/checkout@v3
# # #         with:
# # #           fetch-depth: 0

# # #       # 2Ô∏è‚É£ Setup Node (for React tests)
# # #       - name: Set up Node.js
# # #         uses: actions/setup-node@v3
# # #         with:
# # #           node-version: '18'

# # #       - name: Install npm dependencies
# # #         run: npm install --legacy-peer-deps

# # #       # 3Ô∏è‚É£ Get changed JSX/TSX files
# # #       - name: Get changed files
# # #         id: changed-files
# # #         run: |
# # #           FILES=$(git diff --name-only \
# # #             ${{ github.event.pull_request.base.sha }} \
# # #             ${{ github.sha }} | grep -E '\.jsx$|\.tsx$' | xargs)
# # #           echo "files=$FILES" >> $GITHUB_OUTPUT

# # #       # 4Ô∏è‚É£ Checkout PRIVATE UTG repo using PAT
# # #       - name: Checkout UnitTestGenerationSystem (PRIVATE)
# # #         if: steps.changed-files.outputs.files != ''
# # #         uses: actions/checkout@v3
# # #         with:
# # #           repository: prakalps/UnitTestGenerationSystem
# # #           token: ${{ secrets.GH_TOKEN }}
# # #           path: utg

# # #       # 5Ô∏è‚É£ Setup Python for UTG
# # #       - name: Set up Python
# # #         if: steps.changed-files.outputs.files != ''
# # #         uses: actions/setup-python@v4
# # #         with:
# # #           python-version: '3.10'

# # #       - name: Install UTG dependencies
# # #         if: steps.changed-files.outputs.files != ''
# # #         run: |
# # #           pip install openai python-dotenv

# # #       # 6Ô∏è‚É£ Run UTG test generation
# # #       - name: Generate tests using UTG
# # #         if: steps.changed-files.outputs.files != ''
# # #         env:
# # #           OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
# # #         run: |
# # #           python utg/scripts/agentic_pr_generator.py \
# # #             ${{ steps.changed-files.outputs.files }}

# # #       # 7Ô∏è‚É£ Run React tests
# # #       - name: Run generated tests
# # #         run: npm test -- --coverage

# # #       # 8Ô∏è‚É£ Commit generated tests back to PR branch (FIXED)
# # #       - name: Commit generated tests
# # #         run: |
# # #           git config --global user.name 'github-actions[bot]'
# # #           git config --global user.email 'github-actions[bot]@users.noreply.github.com'
# # #           git add .
# # #           git commit -m "chore: add agentic generated tests [skip ci]" || echo "No changes"
# # #           git push origin HEAD:${{ github.head_ref }}

# # #       # 9Ô∏è‚É£ Comment PR with results
# # #       - name: Comment PR with results
# # #         uses: actions/github-script@v6
# # #         if: always()
# # #         with:
# # #           script: |
# # #             const fs = require('fs');
# # #             const path = 'src/logs/pr_test_generation.json';
# # #             if (!fs.existsSync(path)) return;

# # #             const results = JSON.parse(fs.readFileSync(path, 'utf8'));

# # #             const comment = `## ü§ñ Agentic Test Generation Results

# # #             **Files Processed:** ${results.filesProcessed}
# # #             **Tests Generated:** ${results.testsGenerated}
# # #             **Tests Passed:** ${results.testsPassed} ‚úÖ

# # #             ### üí∞ Cost Report
# # #             - **Total Cost:** $${results.cost_report.total_cost}
# # #             - **Total Tokens:** ${results.cost_report.total_tokens}
# # #             `;

# # #             github.rest.issues.createComment({
# # #               issue_number: context.issue.number,
# # #               owner: context.repo.owner,
# # #               repo: context.repo.repo,
# # #               body: comment
# # #             });

# # # name: Auto Test Generation

# # # on:
# # #   pull_request:
# # #     paths:
# # #       - 'src/**/*.jsx'
# # #       - 'src/**/*.tsx'

# # # jobs:
# # #   generate-tests:
# # #     runs-on: ubuntu-latest

# # #     steps:
# # #       # 1Ô∏è‚É£ Checkout React project
# # #       - name: Checkout React project
# # #         uses: actions/checkout@v3
# # #         with:
# # #           fetch-depth: 0

# # #       # 2Ô∏è‚É£ Setup Node (for React tests)
# # #       - name: Set up Node.js
# # #         uses: actions/setup-node@v3
# # #         with:
# # #           node-version: '18'

# # #       - name: Install npm dependencies
# # #         run: npm install --legacy-peer-deps

# # #       # 3Ô∏è‚É£ Get changed JSX/TSX files
# # #       - name: Get changed files
# # #         id: changed-files
# # #         run: |
# # #           FILES=$(git diff --name-only \
# # #             ${{ github.event.pull_request.base.sha }} \
# # #             ${{ github.sha }} | grep -E '\.jsx$|\.tsx$' | xargs)
# # #           echo "files=$FILES" >> $GITHUB_OUTPUT

# # #       # 4Ô∏è‚É£ Checkout PRIVATE UTG repo using PAT
# # #       - name: Checkout UnitTestGenerationSystem (PRIVATE)
# # #         if: steps.changed-files.outputs.files != ''
# # #         uses: actions/checkout@v3
# # #         with:
# # #           repository: prakalps/UnitTestGenerationSystem
# # #           token: ${{ secrets.GH_TOKEN }}
# # #           path: utg

# # #       # 5Ô∏è‚É£ Setup Python for UTG
# # #       - name: Set up Python
# # #         if: steps.changed-files.outputs.files != ''
# # #         uses: actions/setup-python@v4
# # #         with:
# # #           python-version: '3.10'

# # #       - name: Install UTG dependencies
# # #         if: steps.changed-files.outputs.files != ''
# # #         run: |
# # #           pip install openai python-dotenv

# # #       # 6Ô∏è‚É£ Run UTG test generation
# # #       - name: Generate tests using UTG
# # #         if: steps.changed-files.outputs.files != ''
# # #         env:
# # #           OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
# # #         run: |
# # #           python utg/scripts/agentic_pr_generator.py \
# # #             ${{ steps.changed-files.outputs.files }}

# # #       # 7Ô∏è‚É£ Run React tests
# # #       - name: Run generated tests
# # #         run: npm test -- --coverage

# # #       # 8Ô∏è‚É£ Commit generated tests back to PR branch
# # #       - name: Commit generated tests
# # #         run: |
# # #           git config --global user.name 'github-actions[bot]'
# # #           git config --global user.email 'github-actions[bot]@users.noreply.github.com'
# # #           git add .
# # #           git commit -m "chore: add agentic generated tests [skip ci]" || echo "No changes"
# # #           git push origin HEAD:${{ github.head_ref }}

# # #       # 9Ô∏è‚É£ Comment PR with results (SAFE GUARDED)
# # #       - name: Comment PR with results
# # #         uses: actions/github-script@v6
# # #         if: always()
# # #         with:
# # #           script: |
# # #             const fs = require('fs');
# # #             const path = 'src/logs/pr_test_generation.json';

# # #             if (!fs.existsSync(path)) {
# # #               console.log("UTG results file not found, skipping comment.");
# # #               return;
# # #             }

# # #             const results = JSON.parse(fs.readFileSync(path, 'utf8'));

# # #             const costReport = results.cost_report || {};
# # #             const totalCost = costReport.total_cost ?? "N/A";
# # #             const totalTokens = costReport.total_tokens ?? "N/A";

# # #             const comment = `## ü§ñ Agentic Test Generation Results

# # #             **Files Processed:** ${results.filesProcessed ?? "N/A"}
# # #             **Tests Generated:** ${results.testsGenerated ?? "N/A"}
# # #             **Tests Passed:** ${results.testsPassed ?? "N/A"} ‚úÖ

# # #             ### üí∞ Cost Report
# # #             - **Total Cost:** ${totalCost}
# # #             - **Total Tokens:** ${totalTokens}
# # #             `;

# # #             github.rest.issues.createComment({
# # #               issue_number: context.issue.number,
# # #               owner: context.repo.owner,
# # #               repo: context.repo.repo,
# # #               body: comment
# # #             });


# name: Auto Test Generation

# on:
#   pull_request:
#     paths:
#       - 'src/**/*.jsx'
#       - 'src/**/*.tsx'

# # ‚úÖ REQUIRED PERMISSIONS (FIXES 403 ERROR)
# permissions:
#   contents: write
#   pull-requests: write
#   issues: write

# jobs:
#   generate-tests:
#     runs-on: ubuntu-latest

#     steps:
#       # 1Ô∏è‚É£ Checkout React project
#       - name: Checkout React project
#         uses: actions/checkout@v3
#         with:
#           fetch-depth: 0

#       # 2Ô∏è‚É£ Setup Node (for React tests)
#       - name: Set up Node.js
#         uses: actions/setup-node@v3
#         with:
#           node-version: '18'

#       - name: Install npm dependencies
#         run: npm install --legacy-peer-deps

#       # 3Ô∏è‚É£ Get changed JSX/TSX files
#       - name: Get changed files
#         id: changed-files
#         run: |
#           FILES=$(git diff --name-only \
#             ${{ github.event.pull_request.base.sha }} \
#             ${{ github.sha }} | grep -E '\.jsx$|\.tsx$' | xargs)
#           echo "files=$FILES" >> $GITHUB_OUTPUT

#       # 4Ô∏è‚É£ Checkout PRIVATE UTG repo using PAT
#       - name: Checkout UnitTestGenerationSystem (PRIVATE)
#         if: steps.changed-files.outputs.files != ''
#         uses: actions/checkout@v3
#         with:
#           repository: prakalps/UnitTestGenerationSystem
#           token: ${{ secrets.GH_TOKEN }}
#           path: utg

#       # 5Ô∏è‚É£ Setup Python for UTG
#       - name: Set up Python
#         if: steps.changed-files.outputs.files != ''
#         uses: actions/setup-python@v4
#         with:
#           python-version: '3.10'

#       - name: Install UTG dependencies
#         if: steps.changed-files.outputs.files != ''
#         run: |
#           pip install openai python-dotenv

#       # 6Ô∏è‚É£ Run UTG test generation
#       - name: Generate tests using UTG
#         if: steps.changed-files.outputs.files != ''
#         env:
#           OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
#         run: |
#           python utg/scripts/agentic_pr_generator.py \
#             ${{ steps.changed-files.outputs.files }}

#       # 7Ô∏è‚É£ Run React tests
#       - name: Run generated tests
#         run: npm test -- --coverage

#       # 8Ô∏è‚É£ Commit generated tests back to PR branch
#       - name: Commit generated tests
#         run: |
#           git config --global user.name 'github-actions[bot]'
#           git config --global user.email 'github-actions[bot]@users.noreply.github.com'
#           git add .
#           git commit -m "chore: add agentic generated tests [skip ci]" || echo "No changes"
#           git push origin HEAD:${{ github.head_ref }}

#       # 9Ô∏è‚É£ Comment PR with results (SAFE GUARDED)
#       - name: Comment PR with results
#         uses: actions/github-script@v6
#         if: always()
#         with:
#           script: |
#             const fs = require('fs');
#             const path = 'src/logs/pr_test_generation.json';

#             if (!fs.existsSync(path)) {
#               console.log("UTG results file not found, skipping comment.");
#               return;
#             }

#             const results = JSON.parse(fs.readFileSync(path, 'utf8'));

#             const costReport = results.cost_report || {};
#             const totalCost = costReport.total_cost ?? "N/A";
#             const totalTokens = costReport.total_tokens ?? "N/A";

#             const comment = `## ü§ñ Agentic Test Generation Results

#             **Files Processed:** ${results.filesProcessed ?? "N/A"}
#             **Tests Generated:** ${results.testsGenerated ?? "N/A"}
#             **Tests Passed:** ${results.testsPassed ?? "N/A"} ‚úÖ

#             ### üí∞ Cost Report
#             - **Total Cost:** ${totalCost}
#             - **Total Tokens:** ${totalTokens}
#             `;

#             github.rest.issues.createComment({
#               issue_number: context.issue.number,
#               owner: context.repo.owner,
#               repo: context.repo.repo,
#               body: comment
#             });

# auto-test-gen.yml file for the better llm context new one after the  PR1 solving 

name: Auto Test Generation (UTG)

on:
  pull_request:
    paths:
      - 'src/**/*.jsx'
      - 'src/**/*.tsx'

# =====================================================
# REQUIRED PERMISSIONS (PR comments + commits)
# =====================================================
permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-test-gen:
    runs-on: ubuntu-latest

    steps:
      # =====================================================
      # STEP 1 ‚Äî Checkout React Repository
      # =====================================================
      - name: Checkout React project
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # =====================================================
      # STEP 2 ‚Äî Setup Node.js (React + extractor)
      # =====================================================
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install React dependencies
        run: npm install --legacy-peer-deps

      # =====================================================
      # STEP 3 ‚Äî Detect ALL changed JSX/TSX files
      # (Handles multiple files correctly)
      # =====================================================
      - name: Detect changed React files
        id: changed-files
        run: |
          echo "üîç Detecting changed files..."
          FILES=$(git diff --name-only \
            ${{ github.event.pull_request.base.sha }} \
            ${{ github.sha }} | grep -E '\.jsx$|\.tsx$' || true)

          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "‚úÖ Changed files:"
          echo "$FILES"

      # =====================================================
      # STEP 4 ‚Äî Run React Context Extraction
      # (Your existing extractor logic)
      # =====================================================
      - name: Run React context extraction
        if: steps.changed-files.outputs.files != ''
        run: |
          echo "üöÄ Starting React Context Extraction Pipeline"
          mkdir -p context
          node scripts/extractor/index.js
          echo "‚úÖ UTG prompt generated"
      # =====================================================
      # STEP 5 ‚Äî Append FULL SOURCE CODE to UTG Prompt (CRITICAL)
      # THIS is the missing piece earlier
      # =====================================================
      - name: Append full source code to UTG prompt
        if: steps.changed-files.outputs.files != ''
        run: |
          PROMPT_FILE="context/utg-prompt.txt"

          echo "" >> $PROMPT_FILE
          echo "====================================" >> $PROMPT_FILE
          echo "üì¶ FULL SOURCE CODE CONTEXT" >> $PROMPT_FILE
          echo "====================================" >> $PROMPT_FILE

          for file in ${{ steps.changed-files.outputs.files }}; do
            if [ -f "$file" ]; then
              echo "" >> $PROMPT_FILE
              echo "------------------------------------" >> $PROMPT_FILE
              echo "üìÑ FILE: $file" >> $PROMPT_FILE
              echo "------------------------------------" >> $PROMPT_FILE

              # Log to GitHub Actions UI
              echo "üìÑ Injecting source of $file"

              # Append FULL file source to prompt
              cat "$file" >> $PROMPT_FILE
              echo "" >> $PROMPT_FILE
            fi
          done

          echo "‚úÖ Full source code appended to UTG prompt"

      # =====================================================
      # STEP 6 ‚Äî Validate UTG Prompt
      # (Prevents silent failures)
      # =====================================================
      - name: Validate UTG prompt
        if: steps.changed-files.outputs.files != ''
        run: |
          if [ ! -f "context/utg-prompt.txt" ]; then
            echo "‚ùå UTG prompt not found"
            exit 1
          fi
          echo "‚úÖ UTG prompt ready"
          echo "üìÑ Prompt size:"
          wc -l context/utg-prompt.txt

      # =====================================================
      # STEP 7 ‚Äî Checkout PRIVATE UTG Repository (PAT access)
      # =====================================================
      - name: Checkout UnitTestGenerationSystem (PRIVATE)
        if: steps.changed-files.outputs.files != ''
        uses: actions/checkout@v4
        with:
          repository: prakalps/UnitTestGenerationSystem
          token: ${{ secrets.GH_TOKEN }}
          path: utg

      # =====================================================
      # STEP 8 ‚Äî Inject Prompt into UTG Repo
      # =====================================================
      - name: Inject UTG prompt into UTG repo
        if: steps.changed-files.outputs.files != ''
        run: |
          mkdir -p utg/context
          cp context/utg-prompt.txt utg/context/utg-prompt.txt
          echo "‚úÖ Prompt copied to UTG repo"

      # =====================================================
      # STEP 9 ‚Äî Setup Python for UTG
      # =====================================================
      - name: Set up Python
        if: steps.changed-files.outputs.files != ''
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install UTG dependencies
        if: steps.changed-files.outputs.files != ''
        run: |
          pip install -r utg/requirements.txt

      # =====================================================
      # STEP 10 ‚Äî Run UTG (LLM Test Generation)
      # =====================================================
      - name: Generate tests using UTG
        if: steps.changed-files.outputs.files != ''
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ü§ñ Running UTG with full context"
          python utg/scripts/pr_test_generator.py utg/context/utg-prompt.txt

      # =====================================================
      # STEP 11 ‚Äî Run React Tests with Coverage
      # =====================================================
      - name: Run React tests
        run: npm test -- --coverage

      # =====================================================
      # STEP 12 ‚Äî Commit Generated Tests Back to PR
      # =====================================================
      - name: Commit generated tests
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add .
          git commit -m "chore: add UTG generated tests [skip ci]" || echo "No changes"
          git push origin HEAD:${{ github.head_ref }}

      # =====================================================
      # STEP 13 ‚Äî Comment PR with UTG Summary
      # =====================================================
      - name: Comment PR with UTG results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");

            const reportPath = "src/logs/pr_test_generation.json";
            if (!fs.existsSync(reportPath)) {
              console.log("No UTG report found");
              return;
            }

            const data = JSON.parse(fs.readFileSync(reportPath, "utf8"));

            const comment = `
            ## ü§ñ UTG Test Generation Report

            **Files Processed:** ${data.filesProcessed ?? "N/A"}
            **Tests Generated:** ${data.testsGenerated ?? "N/A"}
            **Tests Passed:** ${data.testsPassed ?? "N/A"} ‚úÖ

            **Total Tokens:** ${data.cost_report?.total_tokens ?? "N/A"}
            **Total Cost:** ${data.cost_report?.total_cost ?? "N/A"}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
